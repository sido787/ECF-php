{% extends "layouts/base.twig" %}

{% block content %}

<div class="container mt-5">

<!-- STATS CARDS -->
<div class="row mb-4">

<div class="col-md-4">
<div class="card shadow-sm border-0">
<div class="card-body">
<h6 class="text-muted">Total Livres</h6>
<h3 class="fw-bold">{{ livres|length }}</h3>
</div>
</div>
</div>

<div class="col-md-4">
<div class="card shadow-sm border-0">
<div class="card-body">
<h6 class="text-muted">Disponible</h6>
<h3 class="fw-bold text-success">
{{ livres|filter(l => l.disponible == 1)|length }}
</h3>
</div>
</div>
</div>

<div class="col-md-4">
<div class="card shadow-sm border-0">
<div class="card-body">
<h6 class="text-muted">Non disponible</h6>
<h3 class="fw-bold text-danger">
{{ livres|filter(l => l.disponible == 0)|length }}
</h3>
</div>
</div>
</div>

</div>

<!-- HEADER -->
<div class="d-flex justify-content-between align-items-center mb-3">

<h2 class="fw-bold">Gestion des livres</h2>

<a href="?page=livre.add" class="btn btn-primary shadow-sm">
 Ajouter un livre
</a>

</div>

<!-- SEARCH -->
<input 
type="text"
id="searchInput"
class="form-control mb-3"
placeholder=" Rechercher un livre...">

{% if livres is not empty %}

<div class="card shadow-sm">
<div class="card-body p-0">

<table class="table table-hover align-middle mb-0">

<thead class="table-dark">
<tr>
<th>ID</th>
<th>Titre</th>
<th>Année</th>
<th>Disponible</th>
<th>Actions</th>
</tr>
</thead>

<tbody>

{% for livre in livres %}
<tr>

<td class="fw-bold">{{ livre.id }}</td>

<td>{{ livre.titre }}</td>

<td>{{ livre.annee_publication }}</td>

<td>

{% if livre.disponible == 1 %}
<span class="badge rounded-pill bg-success px-3"> Disponible</span>
{% else %}
<span class="badge rounded-pill bg-danger px-3"> Non disponible</span>
{% endif %}

</td>

<td>

<button
class="btn btn-sm btn-danger btn-delete"
data-id="{{ livre.id }}">
 Supprimer
</button>

<button 
class="btn btn-sm btn-warning text-dark btn-edit"
data-id="{{ livre.id }}"
data-titre="{{ livre.titre }}"
data-annee="{{ livre.annee_publication }}"
data-disponible="{{ livre.disponible }}">
 Modifier
</button>

</td>

</tr>
{% endfor %}

</tbody>

</table>

</div>
</div>

{% else %}

<div class="alert alert-warning shadow-sm">
Aucun livre trouvé
</div>

{% endif %}

</div>

<script>

// =====================
// DELETE
// =====================

document.querySelectorAll('.btn-delete').forEach(btn => {

    btn.addEventListener('click', function(){

        if(!confirm('Confirmer suppression ?')) return;

        let id = this.dataset.id;

        fetch('index.php?page=livre.delete', {
            method:'POST',
            headers:{
                'Content-Type':'application/x-www-form-urlencoded'
            },
            body:`id=${id}`
        })
        .then(res => res.json())
        .then(data => {

            if(data.success){
                shadowToast('Livre supprimé');
                location.reload();
            }

        });

    });

});


// =====================
// EDIT
// =====================

document.querySelectorAll('.btn-edit').forEach(btn => {

    btn.addEventListener('click', function(){

        let row = this.closest('tr');

        let id = this.dataset.id;
        let titre = this.dataset.titre;
        let annee = this.dataset.annee;
        let disponible = this.dataset.disponible == 1 ? 'checked' : '';

        row.innerHTML = `
        <td>${id}</td>
        <td><input class="form-control edit-titre" value="${titre}"></td>
        <td><input class="form-control edit-annee" value="${annee}"></td>
        <td>
            <input type="checkbox" class="form-check-input edit-dispo" ${disponible}>
        </td>
        <td>
            <button class="btn btn-success btn-save">Save</button>
        </td>
        `;

        row.querySelector('.btn-save').addEventListener('click', function(){

            let newTitre = row.querySelector('.edit-titre').value;
            let newAnnee = row.querySelector('.edit-annee').value;
            let newDispo = row.querySelector('.edit-dispo').checked ? 1 : 0;

            fetch('index.php?page=livre.edit', {

                method:'POST',
                headers:{
                    'Content-Type':'application/x-www-form-urlencoded'
                },
                body:`id=${id}&titre=${newTitre}&annee=${newAnnee}&disponible=${newDispo}`

            })
            .then(res => res.json())
            .then(data => {

                if(data.success){
                    shadowToast('Livre modifié');
                    location.reload();
                }

            });

        });

    });

});

</script>
{% endblock %}